# Тестовое задание для разработчика

Есть список прокси, которые могут одновременно использоваться различными сборщиками. Необходимо спроектировать и написать сервис который будет распределять адреса прокси серверов по обработчикам по мере поступления запросов от обработчиков. Назовем его сервис доступов. При запросе прокси сборщик сообщает сервису доступов id ресурса, которые он собирается собрать. Один ресурс должен собираться одновременно только с одного адреса. Будем считать, что количество ресурсов конечно и не превышает 50.

### Аттрибуты прокси, доступные для поиска:

- `country` - страна
- `rpw` - обработанное количество запросов за неделю
- `resourse_ids` - список ресурсов для которых этот прокси сервер может использоваться

### Что нужно:

- Отдавать адрес прокси сервера по запросу и не отдавать этот адрес остальным обработчикам этого ресурса в течение переданного ttl. Требования к атрибутам прокси, которую запрашивает сборщик, могут быть произвольным в пределах имеющейся модели данных.
- Хранить данные о том какие прокси сейчас заняты для соответствующих ресурсов in-memory из-за высокой нагрузки на сервис.
- Иметь возможность восстановить состояние после аварийного завершения

## Технические требования:

- Любой python фреймворк кроме Django и DRF
- Сервис работает в Docker
- Сервис обрабатывает 50 rps

## Misc

- `README` с гайдом по поднятию и описанием архитектуры приложения
- Если будет REST - `docs.json` с openapi документацией


# Реализация

Реализовано приложение на фреймворке Flask. Это вторая реализация этого задания. Основной упор в нем сделан чтобы показать навыки программирования. 

Логика работы основана на работе со словарем, ключами которого являются id сервисов, значения ключей- словарь, содержащий массив свободных и занятых прокси. 

Как только поступает запрос на выделение сервера, из словаря берется набор данных для указанного id сервиса, ищутся в нем свободные серверы. Если находится свободный сервер, то ему в параметр ttl ставится текущее время+ время аренды, увеличивается счетчик запросов, помещается в список занятых серверов. 

В начале каждого запроса проходим по всем id сервисов и очищаем от просроченных серверов в списке занытях. Если аренда сервера просрочена, возвращаем его в список свободных серверов. 

При отдаче клиенту сервера, полностью отдаем ему объект прокси сервера, содержащий все возможные поля: адрес, количество запросов за неделю, список сервисов на этом прокси. 

Для обеспечения бесперебойной работы ведется каждую секунду приземление объекта данных о статусе серверов на диск. При запуске приложения отдается предпочтение уже имеющемуся файлу данных. 

Существенным преимуществом этой реализации является то, что проект выдерживает существенное количество запросов в минуту. 

## Эндпоинты


| Эндпоинт    | Поле    | описание |
| ----------- | ----------- | ----------- |
| /allocate/\<proc_id>/\<ttl>/\<country> |  | Эндпоинт выдачи в аренду прокси сервера с фильтром по стране |
| | proc_id | id ресурса |
| | ttl | Время аренды |
| | country | Страна с для которой нужно выдать прокси |
| /allocate/\<proc_id>/\<ttl> |  | Эндпоинт выдачи в аренду прокси сервера без фильтра по стране |
| | proc_id | id ресурса |
| | ttl | Время аренды |



## Дерево проекта


```
.
├── Dockerfile Файл для запуска докера
├── README.md Документация
├── app.py Приложение 
├── data.json Файл данных для возобновления работы после сбоя
├── proxy_list.json Список серверов
└── requirements.txt Список зависимостей для докера
```

## Формат хранения данных прокси

Массив словарей, где есть ключи: 

* `address` - адрес сервера
* `country` - страна, в которой расположен прокис
* `rpw` - RequestsPerWeek Запросы в неделю 
* `resource_ids` -  массив ресурсов, с которыми может данный прокси работать

```
proxies = [
    {'address': 'proxy1.com', 'country': 'USA', 'rpw': 100, 'resource_ids': [1, 2, 3]},
    {'address': 'proxy2.com', 'country': 'Canada', 'rpw': 50, 'resource_ids': [2, 3]},
    {'address': 'proxy3.com', 'country': 'USA', 'rpw': 200, 'resource_ids': [1]},
    {'address': 'proxy4.com', 'country': 'Canada', 'rpw': 150, 'resource_ids': [1, 2]},
]
```

## Установка проекта в Docker

1. Отредактировать файл `resource_ids` и внести свои прокси в него. 
2. Запустить команду в терминале из папки проекта `sudo docker build -t myimage .`
3. Запустить контейнер: ` sudo docker run -d -p 5000:5000 myimage`
4. Проект будет доступен на портах 5000 этого сервера.

