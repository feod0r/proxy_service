# Тестовое задание для разработчика

Есть список прокси, которые могут одновременно использоваться различными сборщиками. Необходимо спроектировать и написать сервис который будет распределять адреса прокси серверов по обработчикам по мере поступления запросов от обработчиков. Назовем его сервис доступов. При запросе прокси сборщик сообщает сервису доступов id ресурса, которые он собирается собрать. Один ресурс должен собираться одновременно только с одного адреса. Будем считать, что количество ресурсов конечно и не превышает 50.

### Аттрибуты прокси, доступные для поиска:

- `country` - страна
- `rpw` - обработанное количество запросов за неделю
- `resourse_ids` - список ресурсов для которых этот прокси сервер может использоваться

### Что нужно:

- Отдавать адрес прокси сервера по запросу и не отдавать этот адрес остальным обработчикам этого ресурса в течение переданного ttl. Требования к атрибутам прокси, которую запрашивает сборщик, могут быть произвольным в пределах имеющейся модели данных.
- Хранить данные о том какие прокси сейчас заняты для соответствующих ресурсов in-memory из-за высокой нагрузки на сервис.
- Иметь возможность восстановить состояние после аварийного завершения

## Технические требования:

- Любой python фреймворк кроме Django и DRF
- Сервис работает в Docker
- Сервис обрабатывает 50 rps

## Misc

- `README` с гайдом по поднятию и описанием архитектуры приложения
- Если будет REST - `docs.json` с openapi документацией


# Реализация

Реализовано приложение на фреймворке Flask. При выборе способа реализации внимание упало на требование по количеству запросов в секунду- 50. Поэтому я выбрал СУБД MySql как основной инструмент при реализации. Тесты показали, что готовый продукт спокойно держит 200 запросов в секунду. 

В базе данных имеется 2 таблицы: 

### Прокси

| Столбец   | Описание   |
| ----------- | ----------- |
| ID | Уникальный ключ |
| address  | Текстовое поле адреса прокси сервера, является индексом |
| as_of_day  | Время добавления прокси сервера в БД |
| country  | Страна в которой он размещен |
| rpw  | Количество запросов за прошедшую неделю чеерез этот прокси |
| resourse_ids | список ресурсов для которых этот прокси сервер может использоваться|


### Логи блокировки

| Столбец   | Описание   |
| ----------- | ----------- |
| ID | Уникальный ключ |
| address  | Текстовое поле адреса прокси сервера, является индексом |
| resource_id  | ID ресурса к которому осуществляется доступ |
| effective_from  | Время начала действия блокировки |
| effective_to  | Время окончания действия блокировки, является индексом |



Алгоритм продукта такой: поступает запрос на выделение прокси сервера. Из списка прокси серверов выбирается такой, что он не состоит в списке занятых под этим ID ресурса и время окончания блокировки еще не истекло. Выбирается преимущественно сервер с минимальным количеством запросов за неделю. 

В таблицу логирования занятых прокси заносится выбранный прокси сервер с параметрами: ID ресурса, время начала блокировки, время окончания блокировки. Клиенту возвращается прокси сервер. 

Подсчет количество запросов к прокси серверам ведется через функцию сбора статистики:  из таблицы логов считаются количество запросов к серверам и заносятся в статистику, удаляются все отбывшую свою блокировку логи прокси. 

## Эндпоинты


| Эндпоинт    | Поле    | описание |
| ----------- | ----------- | ----------- |
| /allocate/<proc_id>/<ttl>/<country> |  | Эндпоинт выдачи в аренду прокси сервера с фильтром по стране |
| | proc_id | id ресурса |
| | ttl | Время аренды |
| | country | Страна с для которой нужно выдать прокси |
| /allocate/<proc_id>/<ttl> |  | Эндпоинт выдачи в аренду прокси сервера без фильтра по стране |
| | proc_id | id ресурса |
| | ttl | Время аренды |
| /stat | | Отображение статистики по прокси серверам: Прокси, страна, сколько раз был выдан для запроса  |


## Дерево проекта


```
.
├── app.py -- Файл приложения
├── createdb.sql -- Файл создания объектов в базе данных
├── Dockerfile -- Файл для создания докер образа
├── requirements.txt -- список необходимых для работы библиотек, они будут установлены в докере 
├── fill_proxy.py -- скрипт для первоначального заполнения списка прокси, если их нет. 
└── requests.sql -- отдельно выписанные основные запросы к базе данных 
```

## Установка проекта в Docker

 1. Создать базу данных apr, из файла `createdb.sql` выполнить два скрипта на создание таблиц. 
 2. Если требуется, в файле `app.py` отредактировать параметры подключения к базе данных: пользователь, пароль, база данных и адрес базы данных. 
 3. Запустить команду в терминале из папки проекта `sudo docker build -t myimage .`
 4. Запустить контейнер: ` sudo docker run -d -p 5000:5000 myimage`
 5. Проект будет доступен на портах 5000 этого сервера. 
